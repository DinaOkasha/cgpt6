name: Automated PR Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write  # âœ… Allows commenting on PRs

jobs:
  pr_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Diff
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }} | jq -Rs .)
          echo "DIFF=$DIFF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - Print PR Diff
        run: echo "$DIFF"

      - name: Send PR Diff to OpenAI API
        run: |
          RAW_RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"model\": \"gpt-3.5-turbo\", \"messages\": [{\"role\": \"system\", \"content\": \"You are a code reviewer. Provide concise, actionable feedback on the following code changes.\"}, {\"role\": \"user\", \"content\": $DIFF}], \"max_tokens\": 500 }")

          echo "RAW_RESPONSE: $RAW_RESPONSE"  # âœ… Debugging: Print API response

          RESPONSE=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content')

          if [[ -z "$RESPONSE" || "$RESPONSE" == "null" ]]; then
            echo "ðŸš¨ OpenAI returned an empty response! Check API key or request."
            exit 1
          fi

          echo "review_comment<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Post Review Comment on PR
        run: gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$review_comment"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

